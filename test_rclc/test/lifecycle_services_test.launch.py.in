import os

import unittest

import ament_index_python
import launch
import launch_ros
import launch_testing
import launch_testing.actions
import launch_testing.asserts
import launch_testing.util
import launch_testing_ros

from launch import LaunchDescription
from launch.events import matches_action
from launch.events.process import ShutdownProcess
from launch_ros.events.lifecycle import ChangeState
from lifecycle_msgs.msg import Transition


def generate_test_description():
    os.environ['OSPL_VERBOSITY'] = '8'
    os.environ['RCUTILS_CONSOLE_OUTPUT_FORMAT'] = '{message}'

    modelfile = '@MODELFILE@'

    lifecycle_node = launch_ros.actions.Node(
        package='rclc_examples',
        executable='example_lifecycle_node',
        emulate_tty=True,
        output='screen'
        )

    node_configure = launch.actions.TimerAction(
        period=2.,
        actions=[
            launch.actions.EmitEvent(
                event=ChangeState(
                    lifecycle_node_matcher=matches_action(lifecycle_node),
                    transition_id=Transition.TRANSITION_CONFIGURE))
        ]
    )

    launch_description = LaunchDescription()
    launch_description.add_action(lifecycle_node)
    launch_description.add_action(launch_testing.util.KeepAliveProc())
    launch_description.add_action(node_configure)
    launch_description.add_action(launch_testing.actions.ReadyToTest())

    return launch_description, locals()

class TestModeManagement(unittest.TestCase):

    def test_processes_output(self, proc_output, lifecycle_node):
        """Check lifecycle_node logging output for expected strings."""

        from launch_testing.tools.output import get_default_filtered_prefixes
        output_filter = launch_testing_ros.tools.basic_output_filter(
            filtered_prefixes=get_default_filtered_prefixes() + ['service not available, waiting...'],
            filtered_rmw_implementation='@rmw_implementation@'
        )
        proc_output.assertWaitFor(
            expected_output=launch_testing.tools.expected_output_from_file(path="@EXPECTED_OUTPUT@"),
            process=lifecycle_node,
            output_filter=output_filter,
            timeout=10
        )
